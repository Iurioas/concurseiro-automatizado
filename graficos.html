<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gráficos - Concurseiro Automatizado</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .chart-container {
      max-width: 600px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div class="title-container">
    <h1 id="title">Concurseiro Automatizado</h1>
  </div>
  <nav>
    <a href="planner.html">Planejador</a>
    <a href="study.html">Planejado</a>
    <a href="achievements.html">Conquistas</a>
    <a href="ranking.html">Ranking</a>
    <button onclick="signOut()">Sair</button>
  </nav>
  <main>
    <h1>Gráficos de Progresso</h1>
    <button onclick="location.href='study.html'">Voltar</button>
    <div class="chart-container"><canvas id="progressChart"></canvas></div>
    <div class="chart-container"><canvas id="difficultyChart"></canvas></div>
    <div class="chart-container"><canvas id="progressTimeChart"></canvas></div>
    <div class="chart-container"><canvas id="timePerSubjectChart"></canvas></div>
    <div class="chart-container"><canvas id="overallProgressChart"></canvas></div>
    <div id="loading">Carregando gráficos...</div>
  </main>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import { playClickSound } from "./sounds.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7NfWNyIc-6PmkPqGql-N9lMiiQR8uJgo",
      authDomain: "concurseiro-automatizado.firebaseapp.com",
      projectId: "concurseiro-automatizado",
      storageBucket: "concurseiro-automatizado.firebasestorage.app",
      messagingSenderId: "938840578480",
      appId: "1:938840578480:web:4e8dd7e2dfdc42d7649e75",
      measurementId: "G-H72D875STB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log("Usuário não autenticado. Redirecionando para login...");
        document.getElementById("loading").innerText = "Você não está autenticado. Redirecionando para login...";
        setTimeout(() => location.href = "login.html", 1000);
        return;
      }
      console.log("Usuário autenticado:", user.uid);
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const planDoc = await getDoc(doc(db, "plans", user.uid));
        
        const logs = userDoc.exists() && userDoc.data().logs ? userDoc.data().logs : [];
        console.log("Logs carregados:", logs.length, "registros", logs);
        
        const totalSteps = planDoc.exists() && planDoc.data().plan ? planDoc.data().plan.length : 0;
        console.log("Total de etapas do plano:", totalSteps);
        
        if (logs.length === 0) {
          console.warn("Nenhum log encontrado. Exibindo mensagem de ausência de dados.");
          document.getElementById("loading").innerText = "Nenhum dado de estudo registrado ainda. Conclua etapas no Planejado para ver gráficos!";
          return;
        }

        renderCharts(logs, totalSteps);
        document.getElementById("loading").style.display = "none";
      } catch (error) {
        console.error("Erro ao carregar dados para gráficos:", error.message);
        document.getElementById("loading").innerText = "Erro ao carregar gráficos: " + error.message;
      }
    });

    function renderCharts(logs, totalSteps) {
      console.log("Iniciando renderização dos gráficos...");

      // Gráfico 1: Tempo Gasto e Nota por Etapa (Barras)
      const progressCtx = document.getElementById("progressChart").getContext("2d");
      new Chart(progressCtx, {
        type: "bar",
        data: {
          labels: logs.map(log => `Etapa ${log.etapa}`),
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: logs.map(log => parseInt(log.tempo_gasto) || 0),
              backgroundColor: "#9575CD",
              yAxisID: "y"
            },
            {
              label: "Nota Autoavaliação",
              data: logs.map(log => parseInt(log.nota_autoavaliacao) || 0),
              backgroundColor: "#D1C4E9",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, position: "left", title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, max: 10, position: "right", title: { display: true, text: "Nota (0-10)" } }
          },
          plugins: { title: { display: true, text: "Tempo e Nota por Etapa" } }
        }
      });
      console.log("Gráfico 1 (Tempo e Nota) renderizado.");

      // Gráfico 2: Distribuição de Dificuldade (Pizza)
      const difficultyCount = logs.reduce((acc, log) => {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      console.log("Contagem de dificuldades:", difficultyCount);
      const difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
      new Chart(difficultyCtx, {
        type: "pie",
        data: {
          labels: Object.keys(difficultyCount),
          datasets: [{
            data: Object.values(difficultyCount),
            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"]
          }]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: "Distribuição por Dificuldade" } }
        }
      });
      console.log("Gráfico 2 (Dificuldade) renderizado.");

      // Gráfico 3: Progresso Acumulado ao Longo do Tempo (Linha)
      const dates = logs.map(log => new Date(log.data_conclusao).toLocaleDateString());
      const cumulativeProgress = logs.map((_, index) => index + 1);
      console.log("Datas e progresso acumulado:", dates, cumulativeProgress);
      const progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
      new Chart(progressTimeCtx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [{
            label: "Etapas Concluídas",
            data: cumulativeProgress,
            borderColor: "#9575CD",
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Etapas" } } },
          plugins: { title: { display: true, text: "Progresso Acumulado ao Longo do Tempo" } }
        }
      });
      console.log("Gráfico 3 (Progresso ao Longo do Tempo) renderizado.");

      // Gráfico 4: Tempo Médio por Matéria (Barras)
      const subjectTime = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const subjects = Object.keys(subjectTime);
      const avgTime = subjects.map(subject => subjectTime[subject].total / subjectTime[subject].count);
      console.log("Matérias e tempo médio:", subjects, avgTime);
      const timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
      new Chart(timePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Tempo Médio (min)",
            data: avgTime,
            backgroundColor: "#4CAF50"
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Minutos" } } },
          plugins: { title: { display: true, text: "Tempo Médio por Matéria" } }
        }
      });
      console.log("Gráfico 4 (Tempo por Matéria) renderizado.");

      // Gráfico 5: Progresso Geral (Rosca)
      const completed = logs.length;
      const remaining = totalSteps - completed;
      console.log("Progresso geral - Concluído:", completed, "Restante:", remaining);
      const overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
      new Chart(overallProgressCtx, {
        type: "doughnut",
        data: {
          labels: ["Concluído", "Restante"],
          datasets: [{
            data: [completed, remaining],
            backgroundColor: ["#4CAF50", "#E0E0E0"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: "Progresso Geral do Plano" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const total = completed + remaining;
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      console.log("Gráfico 5 (Progresso Geral) renderizado.");
    }

    window.signOut = async () => {
      playClickSound();
      try {
        await signOut(auth);
        localStorage.clear();
        console.log("Logout realizado.");
        location.href = "index.html";
      } catch (error) {
        console.error("Erro ao sair:", error.message);
        alert("Erro ao sair: " + error.message);
      }
    };
  </script>
</body>
</html>
