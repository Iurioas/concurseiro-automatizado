<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gráficos - Concurseiro Automatizado</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav>
    <span>Concurseiro Automatizado</span>
    <a href="planner.html">Planejador</a>
    <a href="study.html">Planejado</a>
    <button onclick="signOut()">Sair</button>
  </nav>
  <h1>Gráficos</h1>
  <button onclick="location.href='study.html'">Voltar</button>
  <div class="chart-container">
    <canvas id="tempoChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="dificuldadeChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="autoavaliacaoChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="progressoChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="dificuldadeTotalChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="tempoDificuldadeChart"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="dispersaoChart"></canvas>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7NfWNyIc-6PmkPqGql-N9lMiiQR8uJgo",
      authDomain: "concurseiro-automatizado.firebaseapp.com",
      projectId: "concurseiro-automatizado",
      storageBucket: "concurseiro-automatizado.firebasestorage.app",
      messagingSenderId: "938840578480",
      appId: "1:938840578480:web:4e8dd7e2dfdc42d7649e75",
      measurementId: "G-H72D875STB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
      } else {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const logs = userDoc.exists() && userDoc.data().logs ? userDoc.data().logs : [];
        renderCharts(logs);
      }
    });

    function renderCharts(logs) {
      const materias = [...new Set(logs.map(log => log.materia))];
      const tempoPorMateria = materias.map(m => ({
        materia: m,
        tempo: logs.filter(log => log.materia === m).reduce((sum, log) => sum + log.tempo_gasto, 0)
      }));
      const dificuldadePorMateria = materias.map(m => ({
        materia: m,
        facil: logs.filter(log => log.materia === m && log.dificuldade === "Fácil").length,
        medio: logs.filter(log => log.materia === m && log.dificuldade === "Médio").length,
        dificil: logs.filter(log => log.materia === m && log.dificuldade === "Difícil").length
      }));
      const mediaAutoavaliacaoPorMateria = materias.map(m => {
        const notas = logs.filter(log => log.materia === m).map(log => log.nota_autoavaliacao);
        const media = notas.length > 0 ? notas.reduce((sum, n) => sum + n, 0) / notas.length : 0;
        return { materia: m, media: media.toFixed(2) };
      });
      const progressoAutoavaliacao = logs.map((log, idx) => ({ etapa: idx + 1, nota: log.nota_autoavaliacao }));
      const dificuldadeTotal = {
        facil: logs.filter(log => log.dificuldade === "Fácil").length,
        medio: logs.filter(log => log.dificuldade === "Médio").length,
        dificil: logs.filter(log => log.dificuldade === "Difícil").length
      };
      const tempoMedioPorDificuldade = [
        { dificuldade: "Fácil", tempo: logs.filter(log => log.dificuldade === "Fácil").reduce((sum, log) => sum + log.tempo_gasto, 0) / (dificuldadeTotal.facil || 1) },
        { dificuldade: "Médio", tempo: logs.filter(log => log.dificuldade === "Médio").reduce((sum, log) => sum + log.tempo_gasto, 0) / (dificuldadeTotal.medio || 1) },
        { dificuldade: "Difícil", tempo: logs.filter(log => log.dificuldade === "Difícil").reduce((sum, log) => sum + log.tempo_gasto, 0) / (dificuldadeTotal.dificil || 1) }
      ];
      const dispersaoDados = logs.map(log => ({ materia: log.materia, tempo: log.tempo_gasto, nota: log.nota_autoavaliacao }));

      // Gráfico de Tempo por Matéria
      new Chart(document.getElementById("tempoChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: tempoPorMateria.map(t => t.materia),
          datasets: [{
            label: "Tempo Total (min)",
            data: tempoPorMateria.map(t => t.tempo),
            backgroundColor: "#42a5f5"
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });

      // Gráfico de Dificuldade por Matéria
      new Chart(document.getElementById("dificuldadeChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: dificuldadePorMateria.map(d => d.materia),
          datasets: [
            { label: "Fácil", data: dificuldadePorMateria.map(d => d.facil), backgroundColor: "#4caf50" },
            { label: "Médio", data: dificuldadePorMateria.map(d => d.medio), backgroundColor: "#ffca28" },
            { label: "Difícil", data: dificuldadePorMateria.map(d => d.dificil), backgroundColor: "#ef5350" }
          ]
        },
        options: {
          scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
        }
      });

      // Gráfico de Média de Autoavaliação por Matéria
      new Chart(document.getElementById("autoavaliacaoChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: mediaAutoavaliacaoPorMateria.map(m => m.materia),
          datasets: [{
            label: "Média (0-10)",
            data: mediaAutoavaliacaoPorMateria.map(m => m.media),
            backgroundColor: "#ab47bc"
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 10 } }
        }
      });

      // Gráfico de Progresso da Autoavaliação
      new Chart(document.getElementById("progressoChart").getContext("2d"), {
        type: "line",
        data: {
          labels: progressoAutoavaliacao.map(p => `Etapa ${p.etapa}`),
          datasets: [{
            label: "Nota (0-10)",
            data: progressoAutoavaliacao.map(p => p.nota),
            borderColor: "#42a5f5",
            backgroundColor: "rgba(66, 165, 245, 0.2)",
            fill: true
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 10 } }
        }
      });

      // Gráfico de Distribuição Total de Dificuldade
      new Chart(document.getElementById("dificuldadeTotalChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: ["Fácil", "Médio", "Difícil"],
          datasets: [{
            label: "Quantidade de Etapas",
            data: [dificuldadeTotal.facil, dificuldadeTotal.medio, dificuldadeTotal.dificil],
            backgroundColor: ["#4caf50", "#ffca28", "#ef5350"]
          }]
        },
        options: {
          indexAxis: "y",
          scales: { x: { beginAtZero: true } }
        }
      });

      // Gráfico de Tempo Médio por Dificuldade
      new Chart(document.getElementById("tempoDificuldadeChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: tempoMedioPorDificuldade.map(t => t.dificuldade),
          datasets: [{
            label: "Tempo Médio (min)",
            data: tempoMedioPorDificuldade.map(t => t.tempo.toFixed(2)),
            backgroundColor: "#4caf50"
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });

      // Gráfico de Dispersão (Tempo vs. Nota)
      new Chart(document.getElementById("dispersaoChart").getContext("2d"), {
        type: "scatter",
        data: {
          datasets: materias.map(m => ({
            label: m,
            data: dispersaoDados.filter(d => d.materia === m).map(d => ({ x: d.tempo, y: d.nota })),
            backgroundColor: ["#42a5f5", "#4caf50", "#ffca28", "#ef5350", "#ab47bc"][materias.indexOf(m) % 5]
          }))
        },
        options: {
          scales: {
            x: { title: { display: true, text: "Tempo (min)" } },
            y: { title: { display: true, text: "Nota (0-10)" }, beginAtZero: true, max: 10 }
          }
        }
      });
    }

    window.signOut = function() {
      signOut(auth).then(() => {
        location.href = "index.html";
      }).catch((error) => alert(error.message));
    };
  </script>
</body>
</html>
