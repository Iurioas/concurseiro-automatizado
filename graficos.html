<!DOCTYPE html>
<html lang="pt-BR">

    
    
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Gráficos - Concurseiro Automatizado</title>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="styles.css">
      <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.49.1/dist/apexcharts.min.js"></script>
    </head>
<body>
  <div class="title-container">
    <h1 id="title">Concurseiro Automatizado</h1>
  </div>
  <nav>
    <a href="planner.html">Planejador</a>
    <a href="study.html">Planejado</a>
    <a href="achievements.html">Conquistas</a>
    <a href="ranking.html">Ranking</a>
    <button onclick="signOut()">Sair</button>
  </nav>
  <main>
    <h1>Gráficos de Progresso</h1>
    <button onclick="location.href='study.html'">Voltar</button>
    <div class="chart-container"><canvas id="progressChart"></canvas></div>
    <div class="chart-container"><canvas id="difficultyChart"></canvas></div>
    <div class="chart-container"><canvas id="progressTimeChart"></canvas></div>
    <div class="chart-container"><canvas id="timePerSubjectChart"></canvas></div>
    <div class="chart-container"><canvas id="overallProgressChart"></canvas></div>
    <div class="chart-container"><canvas id="avgDifficultyPerSubjectChart"></canvas></div> <!-- Novo gráfico -->
    <div class="chart-container"><canvas id="avgScorePerSubjectChart"></canvas></div> <!-- Novo gráfico -->
    
      <div class="chart-container"><canvas id="totalTimeChart"></canvas></div>
    
<div id="loading">Carregando gráficos...</div>
  </main>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import { playClickSound } from "./sounds.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7NfWNyIc-6PmkPqGql-N9lMiiQR8uJgo",
      authDomain: "concurseiro-automatizado.firebaseapp.com",
      projectId: "concurseiro-automatizado",
      storageBucket: "concurseiro-automatizado.firebasestorage.app",
      messagingSenderId: "938840578480",
      appId: "1:938840578480:web:4e8dd7e2dfdc42d7649e75",
      measurementId: "G-H72D875STB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log("Redirecionando para login...");
        location.href = "login.html";
        return;
      }
      console.log("Usuário autenticado:", user.uid);
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const planDoc = await getDoc(doc(db, "plans", user.uid));
        const logs = userDoc.exists() && userDoc.data().logs ? userDoc.data().logs : [];
        const totalSteps = planDoc.exists() && planDoc.data().plan ? planDoc.data().plan.length : 0;
        renderCharts(logs, totalSteps);
        document.getElementById("loading").style.display = "none";
      } catch (error) {
        console.error("Erro ao carregar dados para gráficos:", error.message);
        document.getElementById("loading").innerText = "Erro ao carregar gráficos: " + error.message;
      }
    });

    
    
    
    
    
    function renderCharts(logs, totalSteps) {
      // Gráfico 1: Tempo Gasto e Nota por Etapa (Barras Agrupadas)
      var progressOptions = {
        chart: { type: "bar", height: 350 },
        series: [
          { name: "Tempo Gasto (min)", data: logs.map(function(log) { return parseInt(log.tempo_gasto) || 0; }) },
          { name: "Nota Autoavaliação", data: logs.map(function(log) { return parseInt(log.nota_autoavaliacao) || 0; }) }
        ],
        xaxis: { categories: logs.map(function(log) { return "Etapa " + log.etapa; }) },
        title: { text: "Tempo e Nota por Etapa" },
        colors: ["#9575CD", "#D1C4E9"],
        dataLabels: { enabled: false },
        yaxis: { title: { text: "Valores" } }
      };
      new ApexCharts(document.querySelector("#progressChart"), progressOptions).render();

      // Gráfico 2: Distribuição de Dificuldade (Barras Horizontais)
      var difficultyCount = logs.reduce(function(acc, log) {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      var difficultyOptions = {
        chart: { type: "bar", height: 350 },
        series: [{ name: "Quantidade", data: Object.values(difficultyCount) }],
        xaxis: { categories: Object.keys(difficultyCount), title: { text: "Quantidade" } },
        yaxis: { title: { text: "Dificuldade" } },
        title: { text: "Distribuição por Dificuldade" },
        plotOptions: { bar: { horizontal: true } },
        colors: ["#4CAF50"],
        dataLabels: { enabled: false }
      };
      new ApexCharts(document.querySelector("#difficultyChart"), difficultyOptions).render();

      // Gráfico 3: Progresso Semanal (Linha)
      var weeklyProgress = {};
      logs.forEach(function(log) {
        var date = new Date(log.data_conclusao);
        var weekStart = new Date(date.setDate(date.getDate() - date.getDay())).toLocaleDateString("pt-BR");
        weeklyProgress[weekStart] = (weeklyProgress[weekStart] || 0) + 1;
      });
      var progressTimeOptions = {
        chart: { type: "line", height: 350 },
        series: [{ name: "Etapas por Semana", data: Object.values(weeklyProgress) }],
        xaxis: { categories: Object.keys(weeklyProgress) },
        yaxis: { title: { text: "Etapas" } },
        title: { text: "Progresso Semanal" },
        colors: ["#9575CD"],
        dataLabels: { enabled: false },
        stroke: { curve: "smooth" }
      };
      new ApexCharts(document.querySelector("#progressTimeChart"), progressTimeOptions).render();

      // Gráfico 4: Tempo Médio e Volume por Matéria (Barras com Linha)
      var subjectTime = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var subjects = Object.keys(subjectTime);
      var avgTime = subjects.map(function(subject) { return subjectTime[subject].total / subjectTime[subject].count; });
      var subjectCount = subjects.map(function(subject) { return subjectTime[subject].count; });
      var timePerSubjectOptions = {
        chart: { type: "bar", height: 350 },
        series: [
          { name: "Tempo Médio (min)", data: avgTime },
          { name: "Nº de Etapas", type: "line", data: subjectCount }
        ],
        xaxis: { categories: subjects },
        yaxis: [
          { title: { text: "Minutos" } },
          { opposite: true, title: { text: "Etapas" } }
        ],
        title: { text: "Tempo Médio e Volume por Matéria" },
        colors: ["#4CAF50", "#9575CD"],
        dataLabels: { enabled: false }
      };
      new ApexCharts(document.querySelector("#timePerSubjectChart"), timePerSubjectOptions).render();

      // Gráfico 5: Progresso Geral (Barras Empilhadas)
      var completed = logs.length;
      var remaining = totalSteps - completed;
      var overallProgressOptions = {
        chart: { type: "bar", height: 350, stacked: true },
        series: [
          { name: "Concluído", data: [completed] },
          { name: "Restante", data: [remaining] }
        ],
        xaxis: { categories: ["Progresso"] },
        yaxis: { title: { text: "Etapas" } },
        title: { text: "Progresso Geral do Plano" },
        colors: ["#4CAF50", "#E0E0E0"],
        dataLabels: { enabled: false },
        tooltip: {
          y: {
            formatter: function(val, opts) {
              var total = completed + remaining;
              var percentage = ((val / total) * 100).toFixed(1);
              return opts.series[opts.seriesIndex][opts.dataPointIndex] + " (" + percentage + "%)";
            }
          }
        }
      };
      new ApexCharts(document.querySelector("#overallProgressChart"), overallProgressOptions).render();

      // Gráfico 6: Dificuldade Média por Matéria (Barras Horizontais)
      var difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
      var difficultyPerSubject = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var avgDifficulty = subjects.map(function(subject) { return difficultyPerSubject[subject].total / difficultyPerSubject[subject].count; });
      var avgDifficultyOptions = {
        chart: { type: "bar", height: 350 },
        series: [{ name: "Dificuldade Média", data: avgDifficulty }],
        xaxis: { categories: subjects, title: { text: "Dificuldade (1-3)" }, max: 3 },
        yaxis: { title: { text: "Matéria" } },
        title: { text: "Dificuldade Média por Matéria" },
        plotOptions: { bar: { horizontal: true } },
        colors: ["#FF9800"],
        dataLabels: { enabled: false }
      };
      new ApexCharts(document.querySelector("#avgDifficultyPerSubjectChart"), avgDifficultyOptions).render();

      // Gráfico 7: Nota Média por Matéria (Barras Horizontais com Linha)
      var scorePerSubject = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var avgScore = subjects.map(function(subject) { return scorePerSubject[subject].total / scorePerSubject[subject].count; });
      var overallAvgScore = logs.reduce(function(sum, log) { return sum + (parseInt(log.nota_autoavaliacao) || 0); }, 0) / logs.length;
      var avgScoreOptions = {
        chart: { type: "bar", height: 350 },
        series: [
          { name: "Nota Média", data: avgScore },
          { name: "Média Geral", type: "line", data: subjects.map(function() { return overallAvgScore; }) }
        ],
        xaxis: { categories: subjects, title: { text: "Nota (0-10)" }, max: 10 },
        yaxis: { title: { text: "Matéria" } },
        title: { text: "Nota Média por Matéria" },
        plotOptions: { bar: { horizontal: true } },
        colors: ["#D1C4E9", "#9575CD"],
        dataLabels: { enabled: false }
      };
      new ApexCharts(document.querySelector("#avgScorePerSubjectChart"), avgScoreOptions).render();

      // Gráfico 8: Eficiência por Dia (Barras Agrupadas)
      var dailyEfficiency = {};
      logs.forEach(function(log) {
        var date = new Date(log.data_conclusao).toLocaleDateString("pt-BR");
        dailyEfficiency[date] = dailyEfficiency[date] || { time: 0, steps: 0 };
        dailyEfficiency[date].time += parseInt(log.tempo_gasto) || 0;
        dailyEfficiency[date].steps += 1;
      });
      var dates = Object.keys(dailyEfficiency);
      var totalTimePerDay = dates.map(function(date) { return dailyEfficiency[date].time; });
      var stepsPerDay = dates.map(function(date) { return dailyEfficiency[date].steps; });
      var totalTimeOptions = {
        chart: { type: "bar", height: 350 },
        series: [
          { name: "Tempo Gasto (min)", data: totalTimePerDay },
          { name: "Etapas Concluídas", data: stepsPerDay }
        ],
        xaxis: { categories: dates },
        yaxis: [
          { title: { text: "Minutos" } },
          { opposite: true, title: { text: "Etapas" } }
        ],
        title: { text: "Eficiência por Dia" },
        colors: ["#9575CD", "#4CAF50"],
        dataLabels: { enabled: false }
      };
      new ApexCharts(document.querySelector("#totalTimeChart"), totalTimeOptions).render();
    }
    ),
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: logs.map(function(log) { return parseInt(log.tempo_gasto) || 0; }),
              backgroundColor: "#9575CD"
            },
            {
              label: "Nota Autoavaliação",
              data: logs.map(function(log) { return parseInt(log.nota_autoavaliacao) || 0; }),
              backgroundColor: "#D1C4E9"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            yAxes: [{
              ticks: { beginAtZero: true },
              scaleLabel: { display: true, labelString: "Valores" }
            }]
          },
          title: { display: true, text: "Tempo e Nota por Etapa" }
        }
      });

      var difficultyCount = logs.reduce(function(acc, log) {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      var difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
      new Chart(difficultyCtx, {
        type: "horizontalBar",
        data: {
          labels: Object.keys(difficultyCount),
          datasets: [{
            label: "Quantidade",
            data: Object.values(difficultyCount),
            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"],
            borderWidth: 1,
            borderColor: "#EDE7F6"
          }]
        },
        options: {
          responsive: true,
          scales: {
            xAxes: [{
              ticks: { beginAtZero: true },
              scaleLabel: { display: true, labelString: "Quantidade" }
            }],
            yAxes: [{
              scaleLabel: { display: true, labelString: "Dificuldade" }
            }]
          },
          title: { display: true, text: "Distribuição por Dificuldade" }
        }
      });

      var weeklyProgress = {};
      logs.forEach(function(log) {
        var date = new Date(log.data_conclusao);
        var weekStart = new Date(date.setDate(date.getDate() - date.getDay())).toLocaleDateString("pt-BR");
        weeklyProgress[weekStart] = (weeklyProgress[weekStart] || 0) + 1;
      });
      var progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
      new Chart(progressTimeCtx, {
        type: "line",
        data: {
          labels: Object.keys(weeklyProgress),
          datasets: [{
            label: "Etapas por Semana",
            data: Object.values(weeklyProgress),
            borderColor: "#9575CD",
            fill: false,
            lineTension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            yAxes: [{
              ticks: { beginAtZero: true },
              scaleLabel: { display: true, labelString: "Etapas" }
            }]
          },
          title: { display: true, text: "Progresso Semanal" }
        }
      });

      var subjectTime = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var subjects = Object.keys(subjectTime);
      var avgTime = subjects.map(function(subject) { return subjectTime[subject].total / subjectTime[subject].count; });
      var subjectCount = subjects.map(function(subject) { return subjectTime[subject].count; });
      var timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
      new Chart(timePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Tempo Médio (min)",
              data: avgTime,
              backgroundColor: "#4CAF50",
              yAxisID: "y-axis-1"
            },
            {
              label: "Nº de Etapas",
              data: subjectCount,
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y-axis-2",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            yAxes: [
              {
                id: "y-axis-1",
                position: "left",
                ticks: { beginAtZero: true },
                scaleLabel: { display: true, labelString: "Minutos" }
              },
              {
                id: "y-axis-2",
                position: "right",
                ticks: { beginAtZero: true },
                scaleLabel: { display: true, labelString: "Etapas" }
              }
            ]
          },
          title: { display: true, text: "Tempo Médio e Volume por Matéria" }
        }
      });

      var completed = logs.length;
      var remaining = totalSteps - completed;
      var overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
      new Chart(overallProgressCtx, {
        type: "bar",
        data: {
          labels: ["Progresso"],
          datasets: [
            {
              label: "Concluído",
              data: [completed],
              backgroundColor: "#4CAF50",
              stack: "Stack 0"
            },
            {
              label: "Restante",
              data: [remaining],
              backgroundColor: "#E0E0E0",
              stack: "Stack 0"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            xAxes: [{ stacked: true }],
            yAxes: [{
              stacked: true,
              ticks: { beginAtZero: true },
              scaleLabel: { display: true, labelString: "Etapas" }
            }]
          },
          title: { display: true, text: "Progresso Geral do Plano" },
          tooltips: {
            callbacks: {
              label: function(tooltipItem, data) {
                var value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                var total = completed + remaining;
                var percentage = ((value / total) * 100).toFixed(1);
                return data.datasets[tooltipItem.datasetIndex].label + ": " + value + " (" + percentage + "%)";
              }
            }
          }
        }
      });

      var difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
      var difficultyPerSubject = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var avgDifficulty = subjects.map(function(subject) { return difficultyPerSubject[subject].total / difficultyPerSubject[subject].count; });
      var avgDifficultyPerSubjectCtx = document.getElementById("avgDifficultyPerSubjectChart").getContext("2d");
      new Chart(avgDifficultyPerSubjectCtx, {
        type: "horizontalBar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Dificuldade Média",
            data: avgDifficulty,
            backgroundColor: "#FF9800"
          }]
        },
        options: {
          responsive: true,
          scales: {
            xAxes: [{
              ticks: { beginAtZero: true, max: 3 },
              scaleLabel: { display: true, labelString: "Dificuldade (1-3)" }
            }]
          },
          title: { display: true, text: "Dificuldade Média por Matéria" }
        }
      });

      var scorePerSubject = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var avgScore = subjects.map(function(subject) { return scorePerSubject[subject].total / scorePerSubject[subject].count; });
      var overallAvgScore = logs.reduce(function(sum, log) { return sum + (parseInt(log.nota_autoavaliacao) || 0); }, 0) / logs.length;
      var avgScorePerSubjectCtx = document.getElementById("avgScorePerSubjectChart").getContext("2d");
      new Chart(avgScorePerSubjectCtx, {
        type: "horizontalBar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Nota Média",
              data: avgScore,
              backgroundColor: "#D1C4E9",
              yAxisID: "y-axis-1"
            },
            {
              label: "Média Geral",
              data: subjects.map(function() { return overallAvgScore; }),
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y-axis-1",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            xAxes: [{
              ticks: { beginAtZero: true, max: 10 },
              scaleLabel: { display: true, labelString: "Nota (0-10)" }
            }]
          },
          title: { display: true, text: "Nota Média por Matéria" }
        }
      });

      var dailyEfficiency = {};
      logs.forEach(function(log) {
        var date = new Date(log.data_conclusao).toLocaleDateString("pt-BR");
        dailyEfficiency[date] = dailyEfficiency[date] || { time: 0, steps: 0 };
        dailyEfficiency[date].time += parseInt(log.tempo_gasto) || 0;
        dailyEfficiency[date].steps += 1;
      });
      var dates = Object.keys(dailyEfficiency);
      var totalTimePerDay = dates.map(function(date) { return dailyEfficiency[date].time; });
      var stepsPerDay = dates.map(function(date) { return dailyEfficiency[date].steps; });
      var totalTimeChartCtx = document.getElementById("totalTimeChart").getContext("2d");
      new Chart(totalTimeChartCtx, {
        type: "bar",
        data: {
          labels: dates,
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: totalTimePerDay,
              backgroundColor: "#9575CD",
              yAxisID: "y-axis-1"
            },
            {
              label: "Etapas Concluídas",
              data: stepsPerDay,
              backgroundColor: "#4CAF50",
              yAxisID: "y-axis-2"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            yAxes: [
              {
                id: "y-axis-1",
                position: "left",
                ticks: { beginAtZero: true },
                scaleLabel: { display: true, labelString: "Minutos" }
              },
              {
                id: "y-axis-2",
                position: "right",
                ticks: { beginAtZero: true },
                scaleLabel: { display: true, labelString: "Etapas" }
              }
            ]
          },
          title: { display: true, text: "Eficiência por Dia" }
        }
      });
    }
    ),
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: logs.map(function(log) { return parseInt(log.tempo_gasto) || 0; }),
              backgroundColor: "#9575CD"
            },
            {
              label: "Nota Autoavaliação",
              data: logs.map(function(log) { return parseInt(log.nota_autoavaliacao) || 0; }),
              backgroundColor: "#D1C4E9"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Valores" } }
          },
          plugins: { title: { display: true, text: "Tempo e Nota por Etapa" } }
        }
      });

      // Gráfico 2: Distribuição de Dificuldade (Barras Horizontais)
      var difficultyCount = logs.reduce(function(acc, log) {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      var difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
      new Chart(difficultyCtx, {
        type: "bar",
        data: {
          labels: Object.keys(difficultyCount),
          datasets: [{
            label: "Quantidade",
            data: Object.values(difficultyCount),
            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"],
            borderWidth: 1,
            borderColor: "#EDE7F6"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: { beginAtZero: true, title: { display: true, text: "Quantidade" } },
            y: { title: { display: true, text: "Dificuldade" } }
          },
          plugins: { title: { display: true, text: "Distribuição por Dificuldade" } }
        }
      });

      // Gráfico 3: Progresso Semanal (Linha)
      var weeklyProgress = {};
      logs.forEach(function(log) {
        var date = new Date(log.data_conclusao);
        var weekStart = new Date(date.setDate(date.getDate() - date.getDay())).toLocaleDateString("pt-BR");
        weeklyProgress[weekStart] = (weeklyProgress[weekStart] || 0) + 1;
      });
      var progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
      new Chart(progressTimeCtx, {
        type: "line",
        data: {
          labels: Object.keys(weeklyProgress),
          datasets: [{
            label: "Etapas por Semana",
            data: Object.values(weeklyProgress),
            borderColor: "#9575CD",
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Etapas" } } },
          plugins: { title: { display: true, text: "Progresso Semanal" } }
        }
      });

      // Gráfico 4: Tempo Médio e Volume por Matéria (Barras com Linha)
      var subjectTime = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var subjects = Object.keys(subjectTime);
      var avgTime = subjects.map(function(subject) { return subjectTime[subject].total / subjectTime[subject].count; });
      var subjectCount = subjects.map(function(subject) { return subjectTime[subject].count; });
      var timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
      new Chart(timePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Tempo Médio (min)",
              data: avgTime,
              backgroundColor: "#4CAF50",
              yAxisID: "y"
            },
            {
              label: "Nº de Etapas",
              data: subjectCount,
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y1",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Etapas" } }
          },
          plugins: { title: { display: true, text: "Tempo Médio e Volume por Matéria" } }
        }
      });

      // Gráfico 5: Progresso Geral (Barras Empilhadas)
      var completed = logs.length;
      var remaining = totalSteps - completed;
      var overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
      new Chart(overallProgressCtx, {
        type: "bar",
        data: {
          labels: ["Progresso"],
          datasets: [
            {
              label: "Concluído",
              data: [completed],
              backgroundColor: "#4CAF50",
              stack: "Stack 0"
            },
            {
              label: "Restante",
              data: [remaining],
              backgroundColor: "#E0E0E0",
              stack: "Stack 0"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: "Etapas" } }
          },
          plugins: {
            title: { display: true, text: "Progresso Geral do Plano" },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var value = context.raw;
                  var total = completed + remaining;
                  var percentage = ((value / total) * 100).toFixed(1);
                  return context.dataset.label + ": " + value + " (" + percentage + "%)";
                }
              }
            }
          }
        }
      });

      // Gráfico 6: Dificuldade Média por Matéria (Barras Horizontais)
      var difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
      var difficultyPerSubject = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var avgDifficulty = subjects.map(function(subject) { return difficultyPerSubject[subject].total / difficultyPerSubject[subject].count; });
      var avgDifficultyPerSubjectCtx = document.getElementById("avgDifficultyPerSubjectChart").getContext("2d");
      new Chart(avgDifficultyPerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Dificuldade Média",
            data: avgDifficulty,
            backgroundColor: "#FF9800"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: { beginAtZero: true, max: 3, title: { display: true, text: "Dificuldade (1-3)" } }
          },
          plugins: { title: { display: true, text: "Dificuldade Média por Matéria" } }
        }
      });

      // Gráfico 7: Nota Média por Matéria (Barras Horizontais com Linha)
      var scorePerSubject = logs.reduce(function(acc, log) {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      var avgScore = subjects.map(function(subject) { return scorePerSubject[subject].total / scorePerSubject[subject].count; });
      var overallAvgScore = logs.reduce(function(sum, log) { return sum + (parseInt(log.nota_autoavaliacao) || 0); }, 0) / logs.length;
      var avgScorePerSubjectCtx = document.getElementById("avgScorePerSubjectChart").getContext("2d");
      new Chart(avgScorePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Nota Média",
              data: avgScore,
              backgroundColor: "#D1C4E9",
              yAxisID: "y"
            },
            {
              label: "Média Geral",
              data: subjects.map(function() { return overallAvgScore; }),
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y",
              fill: false
            }
          ]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 10, title: { display: true, text: "Nota (0-10)" } }
          },
          plugins: { title: { display: true, text: "Nota Média por Matéria" } }
        }
      });

      // Gráfico 8: Eficiência por Dia (Barras Agrupadas)
      var dailyEfficiency = {};
      logs.forEach(function(log) {
        var date = new Date(log.data_conclusao).toLocaleDateString("pt-BR");
        dailyEfficiency[date] = dailyEfficiency[date] || { time: 0, steps: 0 };
        dailyEfficiency[date].time += parseInt(log.tempo_gasto) || 0;
        dailyEfficiency[date].steps += 1;
      });
      var dates = Object.keys(dailyEfficiency);
      var totalTimePerDay = dates.map(function(date) { return dailyEfficiency[date].time; });
      var stepsPerDay = dates.map(function(date) { return dailyEfficiency[date].steps; });
      var totalTimeChartCtx = document.getElementById("totalTimeChart").getContext("2d");
      new Chart(totalTimeChartCtx, {
        type: "bar",
        data: {
          labels: dates,
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: totalTimePerDay,
              backgroundColor: "#9575CD",
              yAxisID: "y"
            },
            {
              label: "Etapas Concluídas",
              data: stepsPerDay,
              backgroundColor: "#4CAF50",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Etapas" } }
          },
          plugins: { title: { display: true, text: "Eficiência por Dia" } }
        }
      });
    }
    `),
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: logs.map(log => parseInt(log.tempo_gasto)),
              backgroundColor: "#9575CD",
            },
            {
              label: "Nota Autoavaliação",
              data: logs.map(log => parseInt(log.nota_autoavaliacao)),
              backgroundColor: "#D1C4E9",
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Valores" } }
          },
          plugins: { title: { display: true, text: "Tempo e Nota por Etapa" } }
        }
      });

      // Gráfico 2: Distribuição de Dificuldade (Barras Horizontais)
      const difficultyCount = logs.reduce((acc, log) => {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      const difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
      new Chart(difficultyCtx, {
        type: "bar",
        data: {
          labels: Object.keys(difficultyCount),
          datasets: [{
            label: "Quantidade",
            data: Object.values(difficultyCount),
            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"],
            borderWidth: 1,
            borderColor: "#EDE7F6"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: { beginAtZero: true, title: { display: true, text: "Quantidade" } },
            y: { title: { display: true, text: "Dificuldade" } }
          },
          plugins: { title: { display: true, text: "Distribuição por Dificuldade" } }
        }
      });

      // Gráfico 3: Progresso Semanal (Linha com Média Móvel)
      const weeklyProgress = {};
      logs.forEach(log => {
        const date = new Date(log.data_conclusao);
        const weekStart = new Date(date.setDate(date.getDate() - date.getDay())).toLocaleDateString("pt-BR");
        weeklyProgress[weekStart] = (weeklyProgress[weekStart] || 0) + 1;
      });
      const progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
      new Chart(progressTimeCtx, {
        type: "line",
        data: {
          labels: Object.keys(weeklyProgress),
          datasets: [{
            label: "Etapas por Semana",
            data: Object.values(weeklyProgress),
            borderColor: "#9575CD",
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Etapas" } } },
          plugins: { title: { display: true, text: "Progresso Semanal" } }
        }
      });

      // Gráfico 4: Tempo Médio e Volume por Matéria (Barras com Linha)
      const subjectTime = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto);
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const subjects = Object.keys(subjectTime);
      const avgTime = subjects.map(subject => subjectTime[subject].total / subjectTime[subject].count);
      const subjectCount = subjects.map(subject => subjectTime[subject].count);
      const timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
      new Chart(timePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Tempo Médio (min)",
              data: avgTime,
              backgroundColor: "#4CAF50",
              yAxisID: "y"
            },
            {
              label: "Nº de Etapas",
              data: subjectCount,
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y1",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Etapas" } }
          },
          plugins: { title: { display: true, text: "Tempo Médio e Volume por Matéria" } }
        }
      });

      // Gráfico 5: Progresso Geral (Barras Empilhadas)
      const completed = logs.length;
      const remaining = totalSteps - completed;
      const overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
      new Chart(overallProgressCtx, {
        type: "bar",
        data: {
          labels: ["Progresso"],
          datasets: [
            {
              label: "Concluído",
              data: [completed],
              backgroundColor: "#4CAF50",
              stack: "Stack 0"
            },
            {
              label: "Restante",
              data: [remaining],
              backgroundColor: "#E0E0E0",
              stack: "Stack 0"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: "Etapas" } }
          },
          plugins: {
            title: { display: true, text: "Progresso Geral do Plano" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const total = completed + remaining;
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.dataset.label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Gráfico 6: Dificuldade Média por Matéria (Barras Horizontais)
      const difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
      const difficultyPerSubject = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const avgDifficulty = subjects.map(subject => difficultyPerSubject[subject].total / difficultyPerSubject[subject].count);
      const avgDifficultyPerSubjectCtx = document.getElementById("avgDifficultyPerSubjectChart").getContext("2d");
      new Chart(avgDifficultyPerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Dificuldade Média",
            data: avgDifficulty,
            backgroundColor: "#FF9800"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: { beginAtZero: true, max: 3, title: { display: true, text: "Dificuldade (1-3)" } }
          },
          plugins: { title: { display: true, text: "Dificuldade Média por Matéria" } }
        }
      });

      // Gráfico 7: Nota Média por Matéria (Barras Horizontais com Linha)
      const scorePerSubject = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const avgScore = subjects.map(subject => scorePerSubject[subject].total / scorePerSubject[subject].count);
      const overallAvgScore = logs.reduce((sum, log) => sum + parseInt(log.nota_autoavaliacao) || 0, 0) / logs.length;
      const avgScorePerSubjectCtx = document.getElementById("avgScorePerSubjectChart").getContext("2d");
      new Chart(avgScorePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Nota Média",
              data: avgScore,
              backgroundColor: "#D1C4E9",
              yAxisID: "y"
            },
            {
              label: "Média Geral",
              data: subjects.map(() => overallAvgScore),
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y",
              fill: false
            }
          ]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 10, title: { display: true, text: "Nota (0-10)" } }
          },
          plugins: { title: { display: true, text: "Nota Média por Matéria" } }
        }
      });

      // Gráfico 8: Eficiência por Dia (Barras Agrupadas)
      const dailyEfficiency = {};
      logs.forEach(log => {
        const date = new Date(log.data_conclusao).toLocaleDateString("pt-BR");
        dailyEfficiency[date] = dailyEfficiency[date] || { time: 0, steps: 0 };
        dailyEfficiency[date].time += parseInt(log.tempo_gasto) || 0;
        dailyEfficiency[date].steps += 1;
      });
      const dates = Object.keys(dailyEfficiency);
      const totalTimePerDay = dates.map(date => dailyEfficiency[date].time);
      const stepsPerDay = dates.map(date => dailyEfficiency[date].steps);
      const totalTimeChartCtx = document.getElementById("totalTimeChart").getContext("2d");
      new Chart(totalTimeChartCtx, {
        type: "bar",
        data: {
          labels: dates,
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: totalTimePerDay,
              backgroundColor: "#9575CD",
              yAxisID: "y"
            },
            {
              label: "Etapas Concluídas",
              data: stepsPerDay,
              backgroundColor: "#4CAF50",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Etapas" } }
          },
          plugins: { title: { display: true, text: "Eficiência por Dia" } }
        }
      });
    }
    `),
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: logs.map(log => parseInt(log.tempo_gasto)),
              backgroundColor: "#9575CD",
            },
            {
              label: "Nota Autoavaliação",
              data: logs.map(log => parseInt(log.nota_autoavaliacao)),
              backgroundColor: "#D1C4E9",
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Valores" } }
          },
          plugins: { title: { display: true, text: "Tempo e Nota por Etapa" } }
        }
      });

      // Gráfico 2: Distribuição de Dificuldade (Barras Horizontais)
      const difficultyCount = logs.reduce((acc, log) => {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      const difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
      new Chart(difficultyCtx, {
        type: "bar",
        data: {
          labels: Object.keys(difficultyCount),
          datasets: [{
            label: "Quantidade",
            data: Object.values(difficultyCount),
            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"],
            borderWidth: 1,
            borderColor: "#EDE7F6"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: { beginAtZero: true, title: { display: true, text: "Quantidade" } },
            y: { title: { display: true, text: "Dificuldade" } }
          },
          plugins: { title: { display: true, text: "Distribuição por Dificuldade" } }
        }
      });

      // Gráfico 3: Progresso Semanal (Linha com Média Móvel)
      const weeklyProgress = {};
      logs.forEach(log => {
        const date = new Date(log.data_conclusao);
        const weekStart = new Date(date.setDate(date.getDate() - date.getDay())).toLocaleDateString("pt-BR");
        weeklyProgress[weekStart] = (weeklyProgress[weekStart] || 0) + 1;
      });
      const progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
      new Chart(progressTimeCtx, {
        type: "line",
        data: {
          labels: Object.keys(weeklyProgress),
          datasets: [{
            label: "Etapas por Semana",
            data: Object.values(weeklyProgress),
            borderColor: "#9575CD",
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Etapas" } } },
          plugins: { title: { display: true, text: "Progresso Semanal" } }
        }
      });

      // Gráfico 4: Tempo Médio e Volume por Matéria (Barras com Linha)
      const subjectTime = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto);
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const subjects = Object.keys(subjectTime);
      const avgTime = subjects.map(subject => subjectTime[subject].total / subjectTime[subject].count);
      const subjectCount = subjects.map(subject => subjectTime[subject].count);
      const timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
      new Chart(timePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Tempo Médio (min)",
              data: avgTime,
              backgroundColor: "#4CAF50",
              yAxisID: "y"
            },
            {
              label: "Nº de Etapas",
              data: subjectCount,
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y1",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Etapas" } }
          },
          plugins: { title: { display: true, text: "Tempo Médio e Volume por Matéria" } }
        }
      });

      // Gráfico 5: Progresso Geral (Barras Empilhadas)
      const completed = logs.length;
      const remaining = totalSteps - completed;
      const overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
      new Chart(overallProgressCtx, {
        type: "bar",
        data: {
          labels: ["Progresso"],
          datasets: [
            {
              label: "Concluído",
              data: [completed],
              backgroundColor: "#4CAF50",
              stack: "Stack 0"
            },
            {
              label: "Restante",
              data: [remaining],
              backgroundColor: "#E0E0E0",
              stack: "Stack 0"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: "Etapas" } }
          },
          plugins: {
            title: { display: true, text: "Progresso Geral do Plano" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const total = completed + remaining;
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.dataset.label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Gráfico 6: Dificuldade Média por Matéria (Barras Horizontais)
      const difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
      const difficultyPerSubject = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const avgDifficulty = subjects.map(subject => difficultyPerSubject[subject].total / difficultyPerSubject[subject].count);
      const avgDifficultyPerSubjectCtx = document.getElementById("avgDifficultyPerSubjectChart").getContext("2d");
      new Chart(avgDifficultyPerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Dificuldade Média",
            data: avgDifficulty,
            backgroundColor: "#FF9800"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            x: { beginAtZero: true, max: 3, title: { display: true, text: "Dificuldade (1-3)" } }
          },
          plugins: { title: { display: true, text: "Dificuldade Média por Matéria" } }
        }
      });

      // Gráfico 7: Nota Média por Matéria (Barras Horizontais com Linha)
      const scorePerSubject = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const avgScore = subjects.map(subject => scorePerSubject[subject].total / scorePerSubject[subject].count);
      const overallAvgScore = logs.reduce((sum, log) => sum + parseInt(log.nota_autoavaliacao) || 0, 0) / logs.length;
      const avgScorePerSubjectCtx = document.getElementById("avgScorePerSubjectChart").getContext("2d");
      new Chart(avgScorePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Nota Média",
              data: avgScore,
              backgroundColor: "#D1C4E9",
              yAxisID: "y"
            },
            {
              label: "Média Geral",
              data: subjects.map(() => overallAvgScore),
              type: "line",
              borderColor: "#9575CD",
              yAxisID: "y",
              fill: false
            }
          ]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 10, title: { display: true, text: "Nota (0-10)" } }
          },
          plugins: { title: { display: true, text: "Nota Média por Matéria" } }
        }
      });

      // Gráfico 8: Eficiência por Dia (Barras Agrupadas)
      const dailyEfficiency = {};
      logs.forEach(log => {
        const date = new Date(log.data_conclusao).toLocaleDateString("pt-BR");
        dailyEfficiency[date] = dailyEfficiency[date] || { time: 0, steps: 0 };
        dailyEfficiency[date].time += parseInt(log.tempo_gasto) || 0;
        dailyEfficiency[date].steps += 1;
      });
      const dates = Object.keys(dailyEfficiency);
      const totalTimePerDay = dates.map(date => dailyEfficiency[date].time);
      const stepsPerDay = dates.map(date => dailyEfficiency[date].steps);
      const totalTimeChartCtx = document.getElementById("totalTimeChart").getContext("2d");
      new Chart(totalTimeChartCtx, {
        type: "bar",
        data: {
          labels: dates,
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: totalTimePerDay,
              backgroundColor: "#9575CD",
              yAxisID: "y"
            },
            {
              label: "Etapas Concluídas",
              data: stepsPerDay,
              backgroundColor: "#4CAF50",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, position: "right", title: { display: true, text: "Etapas" } }
          },
          plugins: { title: { display: true, text: "Eficiência por Dia" } }
        }
      });
    }
    `),
          datasets: [
            {
              label: "Tempo Gasto (min)",
              data: logs.map(log => parseInt(log.tempo_gasto)),
              backgroundColor: "#9575CD",
              yAxisID: "y"
            },
            {
              label: "Nota Autoavaliação",
              data: logs.map(log => parseInt(log.nota_autoavaliacao)),
              backgroundColor: "#D1C4E9",
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, position: "left", title: { display: true, text: "Minutos" } },
            y1: { beginAtZero: true, max: 10, position: "right", title: { display: true, text: "Nota (0-10)" } }
          },
          plugins: { title: { display: true, text: "Tempo e Nota por Etapa" } }
        }
      });

      // Gráfico 2: Distribuição de Dificuldade (Barras Horizontais)
      const difficultyCount = logs.reduce((acc, log) => {
        acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
        return acc;
      }, {});
      const difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
      new Chart(difficultyCtx, {
        type: "bar",
        data: {
          labels: Object.keys(difficultyCount),
          datasets: [{
            label: "Quantidade",
            data: Object.values(difficultyCount),
            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"],
            borderWidth: 1,
            borderColor: "#EDE7F6"
          }]
        },
        options: {
          indexAxis: "y", // Torna o gráfico horizontal
          responsive: true,
          scales: {
            x: { beginAtZero: true, title: { display: true, text: "Quantidade" } },
            y: { title: { display: true, text: "Dificuldade" } }
          },
          plugins: { title: { display: true, text: "Distribuição por Dificuldade" } }
        }
      });

      // Gráfico 3: Progresso Acumulado ao Longo do Tempo (Linha)
      const dates = logs.map(log => new Date(log.data_conclusao).toLocaleDateString());
      const cumulativeProgress = logs.map((_, index) => index + 1);
      const progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
      new Chart(progressTimeCtx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [{
            label: "Etapas Concluídas",
            data: cumulativeProgress,
            borderColor: "#9575CD",
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Etapas" } } },
          plugins: { title: { display: true, text: "Progresso Acumulado ao Longo do Tempo" } }
        }
      });

      // Gráfico 4: Tempo Médio por Matéria (Barras)
      const subjectTime = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.tempo_gasto);
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const subjects = Object.keys(subjectTime);
      const avgTime = subjects.map(subject => subjectTime[subject].total / subjectTime[subject].count);
      const timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
      new Chart(timePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Tempo Médio (min)",
            data: avgTime,
            backgroundColor: "#4CAF50"
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Minutos" } } },
          plugins: { title: { display: true, text: "Tempo Médio por Matéria" } }
        }
      });

      // Gráfico 5: Progresso Geral (Barras Empilhadas)
      const completed = logs.length;
      const remaining = totalSteps - completed;
      const overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
      new Chart(overallProgressCtx, {
        type: "bar",
        data: {
          labels: ["Progresso"],
          datasets: [
            {
              label: "Concluído",
              data: [completed],
              backgroundColor: "#4CAF50",
              stack: "Stack 0"
            },
            {
              label: "Restante",
              data: [remaining],
              backgroundColor: "#E0E0E0",
              stack: "Stack 0"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: "Etapas" } }
          },
          plugins: {
            title: { display: true, text: "Progresso Geral do Plano" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const total = completed + remaining;
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.dataset.label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Novo Gráfico 6: Dificuldade Média por Matéria (Barras)
      const difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
      const difficultyPerSubject = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const avgDifficulty = subjects.map(subject => difficultyPerSubject[subject].total / difficultyPerSubject[subject].count);
      const avgDifficultyPerSubjectCtx = document.getElementById("avgDifficultyPerSubjectChart").getContext("2d");
      new Chart(avgDifficultyPerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Dificuldade Média",
            data: avgDifficulty,
            backgroundColor: "#FF9800"
          }]
        },
        options: {
          responsive: true,
          scales: { 
            y: { 
              beginAtZero: true, 
              max: 3, 
              title: { display: true, text: "Dificuldade (1=Fácil, 3=Difícil)" } 
            } 
          },
          plugins: { title: { display: true, text: "Dificuldade Média por Matéria" } }
        }
      });

      // Novo Gráfico 7: Nota de Autoavaliação Média por Matéria (Barras)
      const scorePerSubject = logs.reduce((acc, log) => {
        acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
        acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
        acc[log.materia].count += 1;
        return acc;
      }, {});
      const avgScore = subjects.map(subject => scorePerSubject[subject].total / scorePerSubject[subject].count);
      const avgScorePerSubjectCtx = document.getElementById("avgScorePerSubjectChart").getContext("2d");
      new Chart(avgScorePerSubjectCtx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Nota Média",
            data: avgScore,
            backgroundColor: "#D1C4E9"
          }]
        },
        options: {
          responsive: true,
          scales: { 
            y: { 
              beginAtZero: true, 
              max: 10, 
              title: { display: true, text: "Nota (0-10)" } 
            } 
          },
          plugins: { title: { display: true, text: "Nota de Autoavaliação Média por Matéria" } }
        }
      });
    }

    window.signOut = async () => {
      playClickSound();
      try {
        await signOut(auth);
        localStorage.clear();
        console.log("Logout realizado.");
        location.href = "index.html";
      } catch (error) {
        console.error("Erro ao sair:", error.message);
        alert("Erro ao sair: " + error.message);
      }
    };
  </script>
</body>
</html>
