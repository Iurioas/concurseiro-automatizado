<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gráficos - Concurseiro Automatizado</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js">
  // Aviso: Verifique se o Chart.js usa eval(). Se sim, pode ser necessário ajustar a CSP ou a biblioteca para evitar bloqueios.
  // Atualmente, mantendo os gráficos de pizza conforme solicitado.
</script>
      // Gráfico 8: Tempo Total Bruto vs Líquido (Barras)
      const totalTimeCtx = document.getElementById("totalTimeChart").getContext("2d");
      new Chart(totalTimeCtx, {
        type: "bar",
        data: {
          labels: ["Tempo Total Bruto", "Tempo Total Líquido"],
          datasets: [{
            label: "Tempo (min)",
            data: [
              logs.reduce((sum, log) => sum + (log.validForRanking ? parseInt(log.tempo_gasto || 0) : 0), 0), // Bruto do relógio
              logs.reduce((sum, log) => sum + parseInt(log.tempo_gasto || 0), 0) // Líquido dos logs
            ],
            backgroundColor: ["#9575CD", "#4CAF50"]
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: "Minutos" } } },
          plugins: { title: { display: true, text: "Tempo Total Bruto vs Líquido" } }
        }
      });
    
</script>
  <style>
    .chart-container {
      max-width: 600px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div class="title-container">
    <h1 id="title">Concurseiro Automatizado</h1>
  </div>
  <nav>
    <a href="planner.html">Planejador</a>
    <a href="study.html">Planejado</a>
    <a href="achievements.html">Conquistas</a>
    <a href="ranking.html">Ranking</a>
    <button onclick="signOut()">Sair</button>
  </nav>
  <main>
    <h1>Gráficos de Progresso</h1>
    <button onclick="location.href='study.html'">Voltar</button>
    <div class="chart-container"><canvas id="progressChart"></canvas></div>
    <div class="chart-container"><canvas id="difficultyChart"></canvas></div>
    <div class="chart-container"><canvas id="progressTimeChart"></canvas></div>
    <div class="chart-container"><canvas id="timePerSubjectChart"></canvas></div>
    <div class="chart-container"><canvas id="overallProgressChart"></canvas></div>
    <div class="chart-container"><canvas id="avgDifficultyPerSubjectChart"></canvas></div> <!-- Novo gráfico -->
    <div class="chart-container"><canvas id="avgScorePerSubjectChart"></canvas></div> <!-- Novo gráfico -->
    
      <div class="chart-container"><canvas id="totalTimeChart"></canvas></div>
    
<div id="loading">Carregando gráficos...</div>
  </main>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    import { playClickSound } from "./sounds.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7NfWNyIc-6PmkPqGql-N9lMiiQR8uJgo",
      authDomain: "concurseiro-automatizado.firebaseapp.com",
      projectId: "concurseiro-automatizado",
      storageBucket: "concurseiro-automatizado.firebasestorage.app",
      messagingSenderId: "938840578480",
      appId: "1:938840578480:web:4e8dd7e2dfdc42d7649e75",
      measurementId: "G-H72D875STB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log("Redirecionando para login...");
        location.href = "login.html";
        return;
      }
      console.log("Usuário autenticado:", user.uid);
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const planDoc = await getDoc(doc(db, "plans", user.uid));
        const logs = userDoc.exists() && userDoc.data().logs ? userDoc.data().logs : [];
        const totalSteps = planDoc.exists() && planDoc.data().plan ? planDoc.data().plan.length : 0;
        renderCharts(logs, totalSteps);
        document.getElementById("loading").style.display = "none";
      } catch (error) {
        console.error("Erro ao carregar dados para gráficos:", error.message);
        document.getElementById("loading").innerText = "Erro ao carregar gráficos: " + error.message;
      }
    });

    function renderCharts(logs, totalSteps, sessions) {
      function renderCharts(logs, totalSteps, sessions) {
        const progressCtx = document.getElementById("progressChart").getContext("2d");
        new Chart(progressCtx, {
          type: "bar",
          data: {
            labels: logs.map(log => "Etapa " + log.etapa),
            datasets: [
              {
                label: "Tempo Gasto (min)",
                data: logs.map(log => parseInt(log.tempo_gasto)),
                backgroundColor: "#9575CD",
                yAxisID: "y"
              },
              {
                label: "Nota Autoavaliação",
                data: logs.map(log => parseInt(log.nota_autoavaliacao)),
                backgroundColor: "#D1C4E9",
                yAxisID: "y1"
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, position: "left", title: { display: true, text: "Minutos" } },
              y1: { beginAtZero: true, max: 10, position: "right", title: { display: true, text: "Nota (0-10)" } }
            },
            plugins: { title: { display: true, text: "Tempo e Nota por Etapa" } }
          }
        });

        const difficultyCount = logs.reduce((acc, log) => {
          acc[log.dificuldade] = (acc[log.dificuldade] || 0) + 1;
          return acc;
        }, {});
        const difficultyCtx = document.getElementById("difficultyChart").getContext("2d");
        new Chart(difficultyCtx, {
          type: "bar",
          data: {
            labels: Object.keys(difficultyCount),
            datasets: [{
              label: "Quantidade",
              data: Object.values(difficultyCount),
              backgroundColor: ["#4CAF50", "#FF9800", "#F44336"]
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { title: { display: true, text: "Distribuição por Dificuldade" } }
          }
        });

        const dates = logs.map(log => new Date(log.data_conclusao).toLocaleDateString());
        const cumulativeProgress = logs.map((_, index) => index + 1);
        const progressTimeCtx = document.getElementById("progressTimeChart").getContext("2d");
        new Chart(progressTimeCtx, {
          type: "line",
          data: {
            labels: dates,
            datasets: [{
              label: "Etapas Concluídas",
              data: cumulativeProgress,
              borderColor: "#9575CD",
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: "Etapas" } } },
            plugins: { title: { display: true, text: "Progresso Acumulado ao Longo do Tempo" } }
          }
        });

        const subjectTime = logs.reduce((acc, log) => {
          acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
          acc[log.materia].total += parseInt(log.tempo_gasto);
          acc[log.materia].count += 1;
          return acc;
        }, {});
        const subjects = Object.keys(subjectTime);
        const avgTime = subjects.map(subject => subjectTime[subject].total / subjectTime[subject].count);
        const timePerSubjectCtx = document.getElementById("timePerSubjectChart").getContext("2d");
        new Chart(timePerSubjectCtx, {
          type: "bar",
          data: {
            labels: subjects,
            datasets: [{
              label: "Tempo Médio (min)",
              data: avgTime,
              backgroundColor: "#4CAF50"
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: "Minutos" } } },
            plugins: { title: { display: true, text: "Tempo Médio por Matéria" } }
          }
        });

        const completed = logs.length;
        const remaining = totalSteps - completed;
        const overallProgressCtx = document.getElementById("overallProgressChart").getContext("2d");
        new Chart(overallProgressCtx, {
          type: "bar",
          data: {
            labels: ["Concluído", "Restante"],
            datasets: [{
              label: "Etapas",
              data: [completed, remaining],
              backgroundColor: ["#4CAF50", "#E0E0E0"]
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { title: { display: true, text: "Progresso Geral do Plano" } }
          }
        });

        const difficultyMap = { "Fácil": 1, "Médio": 2, "Difícil": 3 };
        const difficultyPerSubject = logs.reduce((acc, log) => {
          acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
          acc[log.materia].total += difficultyMap[log.dificuldade] || 0;
          acc[log.materia].count += 1;
          return acc;
        }, {});
        const avgDifficulty = subjects.map(subject => difficultyPerSubject[subject].total / difficultyPerSubject[subject].count);
        const avgDifficultyPerSubjectCtx = document.getElementById("avgDifficultyPerSubjectChart").getContext("2d");
        new Chart(avgDifficultyPerSubjectCtx, {
          type: "bar",
          data: {
            labels: subjects,
            datasets: [{
              label: "Dificuldade Média",
              data: avgDifficulty,
              backgroundColor: "#FF9800"
            }]
          },
          options: {
            responsive: true,
            scales: { 
              y: { 
                beginAtZero: true, 
                max: 3, 
                title: { display: true, text: "Dificuldade (1=Fácil, 3=Difícil)" } 
              } 
            },
            plugins: { title: { display: true, text: "Dificuldade Média por Matéria" } }
          }
        });

        const scorePerSubject = logs.reduce((acc, log) => {
          acc[log.materia] = acc[log.materia] || { total: 0, count: 0 };
          acc[log.materia].total += parseInt(log.nota_autoavaliacao) || 0;
          acc[log.materia].count += 1;
          return acc;
        }, {});
        const avgScore = subjects.map(subject => scorePerSubject[subject].total / scorePerSubject[subject].count);
        const avgScorePerSubjectCtx = document.getElementById("avgScorePerSubjectChart").getContext("2d");
        new Chart(avgScorePerSubjectCtx, {
          type: "bar",
          data: {
            labels: subjects,
            datasets: [{
              label: "Nota Média",
              data: avgScore,
              backgroundColor: "#D1C4E9"
            }]
          },
          options: {
            responsive: true,
            scales: { 
              y: { 
                beginAtZero: true, 
                max: 10, 
                title: { display: true, text: "Nota (0-10)" } 
              } 
            },
            plugins: { title: { display: true, text: "Nota de Autoavaliação Média por Matéria" } }
          }
        });

        const totalTimeCtx = document.getElementById("totalTimeChart").getContext("2d");
        new Chart(totalTimeCtx, {
          type: "bar",
          data: {
            labels: ["Tempo Total Bruto", "Tempo Total Líquido"],
            datasets: [{
              label: "Tempo (min)",
              data: [
                sessions.reduce((sum, s) => sum + s.duration, 0),
                logs.reduce((sum, log) => sum + parseInt(log.tempo_gasto || 0), 0)
              ],
              backgroundColor: ["#9575CD", "#4CAF50"]
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: "Minutos" } } },
            plugins: { title: { display: true, text: "Tempo Total Bruto vs Líquido" } }
          }
        });
      }
    window.signOut = async () => {
      playClickSound();
      try {
        await signOut(auth);
        localStorage.clear();
        console.log("Logout realizado.");
        location.href = "index.html";
      } catch (error) {
        console.error("Erro ao sair:", error.message);
        alert("Erro ao sair: " + error.message);
      }
    };
  </script>
</body>
</html>
